var async=require("async"),md5=require("blueimp-md5");module.exports=function(a){a.getUser=function(b,c){console.log("-----------------------"+b.query.access_token),async.auto({getAccount:[function(c){a.findOne({where:{userToken:b.query.access_token?b.query.access_token:""}},c)}],checkAccount:["getAccount",function(a,b){var c=b.getAccount;null==c?(c={},c.result_code=-2202):c.result_code=1,a(null,c)}]},function(a,b){a?c(a):c(null,b.checkAccount)})},a.remoteMethod("getUser",{accepts:[{arg:"req",type:"object",http:{source:"req"}}],returns:{root:!0,type:"object"},http:{verb:"post",path:"/get_user"}}),a.login=function(b,c,d){async.auto({model:[function(b){a.findOne({where:{nickname:c.username}},b)}],trans:["model",function(b){a.beginTransaction({isolationLevel:a.Transaction.READ_COMMITTED},b)}],check:["trans",function(a,d){var e=md5(c.username+c.password+b.query.app_token);console.log(e);var f=d.model;null!=f&&f.userToken==e?a(null,f):a(null,null)}],commit:["check",function(a,b){b.trans.commit(a)}]},function(a,b){if(a)d(a);else if(console.log("TTT-----------------------------------"+b.check),null!=b.check){var c={};c.user_token=b.check.user_token,c.access_token=c.user_token,c.refresh_token=c.user_token,d(null,c)}})},a.remoteMethod("login",{accepts:[{arg:"req",type:"object",http:{source:"req"}},{arg:"data",type:"object",http:{source:"body"}}],returns:{root:!0,type:"object"},http:{verb:"post",path:"/login"}})};